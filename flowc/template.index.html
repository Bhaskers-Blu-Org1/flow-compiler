<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
        {{FLOWC_NAME}} v{{FLOWC_VERSION}} ({{FLOWC_BUILD}})
        Generated from {{INPUT_FILE}} ({{MAIN_FILE_TS}})
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>{{NAME_UPPER}} [REST Gateway]</title>

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <!-- CSS 
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.3.1/litera/bootstrap.css">
    <style>
        div[data-schemaid=root]>h3{ display: none; }
        div[data-schemaid=root]>p{ font-size: 125%; font-weight: bold; }
        div.pr-button { width: 220px; margin-left: 0px; margin-right: 20px; margin-top: 8px; display: inline-block; vertical-align: top; }
        p.form-text,  
        .pr-button-text {  font-style: italic; font-size: 75%;  white-space: normal; }
        label { font-weight: bold; }
        .pr-stick-on { position: relative; white-space: nowrap;  }
        .pr-stick-right { top: 0; right:0; position: absolute; }
        @media (max-width: 770px) {
            div.pr-button { display: block; }
        }
        p {  font-family: unset; }

        .pr-message-good { font-weight: bold; color: blue; }
        .pr-message-error { font-weight: bold; color: red; }

        #pr-response { font-size: 90%;  white-space: normal; }
        .pr-JSON-boolean { color: orange; display: inline-block; }
        .pr-JSON-number { font-weight: bold;  display: inline-block; }
        .pr-JSON-string { white-space: pre; }
        .pr-JSON-null { color: red; display: inline-block; }
        .pr-JSON-key { font-weight: bold; font-style: italic; }
        .pr-JSON-array { }
        .pr-JSON-object { margin-left: 12px;  }
        .pr-JSON-sticky { margin-right: 12px;  display: inline-block; }

    </style>
</head>
<body>
    <!-- Navigation Bar
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-header-id" class="pr-header">
        <nav class="navbar navbar-expand-sm">
            <div class="navbar-nav mr-auto"><h3>{{NAME_UPPER}}{A:ACTIVE_NODE_UPPER{ - {{ACTIVE_NODE_UPPER}}}A}</h3></div>  
            <div class="navbar-expand ml-auto">
                <ul id="pr-nav-links" class="nav navbar-nav navbar-expand">
{A:ACTIVE_NODE_UPPER{{{HAVE_ACTIVE_NODE}}
                    <li class="nav-item" id="home-menu">
                        <a id="pr-home-link" class="nav-link" href="/-www/index.html">{{NAME}}</a>
                    </li>
}A}

{N:HAVE_CLI{{{HAVE_CLI}}
                    <li class="nav-item dropdown" id="nodes-dropdown">
                        <a id="pr-nodes-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Nodes<b class="caret"></b></a>
                        <div id="pr-nodes-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Internal Nodes</h5>
{C:CLI_NODE_NAME{
                            <a class="dropdown_item doc-selector" href="/-www/{{CLI_NODE_NAME}}-index.html">{{CLI_NODE_NAME}}</a>
                            <i>{{CLI_NODE_DESCRIPTION}}</i>
                            <br>
}C}
                        </div>
                    </li>
}N}
                    <li class="nav-item dropdown" id="graphs-dropdown">
                        <a id="pr-graphs-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Graphs<b class="caret"></b></a>
                        <div id="pr-graphs-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Node Connection Graphs</h5>
{I:ENTRY_NAME{
                            <a class="dropdown_item doc-selector" href="/-docs/{{ENTRY_NAME}}.svg">{{ENTRY_NAME}}</a>
                            <br>
}I}
                        </div>
                    </li>
                    <li class="nav-item dropdown" id="sources-dropdown">
                        <a id="pr-docs-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Sources<b class="caret"></b></a>
                        <div id="pr-docs-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Source Files</h5>
                            <a class="dropdown_item doc-selector" href="/-docs/{{MAIN_FILE}}">{{MAIN_FILE}}</a>
                            <i>{{NAME}} flow file</i>
                            <br>
{P:PROTO_FILE{
                            <a class="dropdown_item doc-selector" href="/-docs/{{PROTO_FILE}}">{{PROTO_FILE}}</a> 
                            <i>{{PROTO_FILE_DESCRIPTION}}</i>
                            <br>
}P}
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- Form Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="pr-panel">
        <div>
            <form method="post" action="#">
                <div id="pr-form-editor" class="m-4"></div>
            </form>
            <div id="pr-form-submit" class="m-4 pr-stick-on">
                <div class="form-group pr-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{MAIN_ENTRY_NAME}}" id="{{MAIN_ENTRY_NAME}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{MAIN_ENTRY_NAME}}</button>
                    <span class="pr-button-text">{{MAIN_ENTRY_DESCRIPTION_HTML}}</span>
                </div>
{I:ALT_ENTRY_NAME{              
                <div class="form-group pr-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{ALT_ENTRY_NAME}}" id="{{ALT_ENTRY_NAME}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{ALT_ENTRY_NAME}}</button>
                    <span class="pr-button-text">{{ALT_ENTRY_DESCRIPTION_HTML}}</span>
                </div>
}I}
                <div class="form-group pr-button pr-debug-button pr-stick-right">
                    <input type="checkbox" name="asycnhronous-calls" checked><span class="pr-button-text"> Overlapped gRPC Calls</span><br>
                    <input type="checkbox" name="time-calls"><span class="pr-button-text"> Return Call Time Information</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Results Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-view" class="pr-view-panel">
        <div id="pr-message"></div>
        <div id="pr-timing" class="w-100">------------</div>
        <div id="pr-response"></div>
    </div>

    <!-- End Document
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/js/jquery.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jsonview/1.2.3/jquery.jsonview.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-json-editor/1.1.0/jquery-json-editor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@1.3.5/dist/jsoneditor.min.js"></script>
    <script>
        var ui_data = {
            "request-schema": {{MAIN_ENTRY_INPUT_SCHEMA_JSON}},
            "methods": [
                {
                    "name": "{{MAIN_ENTRY_NAME}}",
                    "url": "{{MAIN_ENTRY_URL}}",
                    "response-schema": {{MAIN_ENTRY_OUTPUT_SCHEMA_JSON}}
                }
{I:ALT_ENTRY_NAME{               ,{
                    "name": "{{ALT_ENTRY_NAME}}",
                    "url": "{{ALT_ENTRY_URL}}",
                    "response-schema": {{ALT_ENTRY_OUTPUT_SCHEMA_JSON}}
                }
}I}
            ]
        };
        window.PR = {
            ui_data: null,
            init: function(data) {
                PR.ui_data = data;
                /*
                var h = $(window).height() - $(".pr-header").outerHeight(true);
                $('.pr-panel').css("height", h);
                */
                JSONEditor.defaults.iconlibs.oi = JSONEditor.AbstractIconLib.extend({
                    mapping: {
                        "delete": 'delete',
                        edit: 'pencil',
                        add: 'plus',
                        cancel: 'ban',
                        save: 'save',
                        moveup: 'arrow-thick-up',
                        movedown: 'arrow-thick-down',
                        clear: 'circle-x',
                        time: 'timer',
                        calendar: 'calendar',
                        upload: 'cloud-upload',
                    },
                    icon_class: 'oi',
                    icon_prefix: 'oi oi-'
                });
        },
        makeForm: function() {
            var rqt_schema = PR.ui_data["request-schema"];
            rqt_schema["format"] = "grid";
            PR.form = new JSONEditor($('#pr-form-editor')[0], {
                "schema" : rqt_schema,
                "theme" : "bootstrap4",
                "iconlib" : "oi",
                "template" : "handlebars",
                "disable_properties" : true,
                "disable_edit_json" : true
            });
        },
        appendOrReplace: function(obj, cont, repl) {
            if(repl) {
                obj.replaceWith(cont);
            } else {
                obj.html(obj.html()+cont);
            }
            return obj;
        },
        renderJSON: function(count, parentID, jo, replace, keyID) {
            var lc = count + 1;
            var go = $("#"+parentID);
            if(typeof value === 'boolean') {
                PR.appendOrReplace(go, '<div class="pr-JSON-boolean">'+jo+"</div>", replace);
            } else 
            if(typeof jo === 'string' || jo instanceof String) {
                var localID = parentID+'-'+lc;
                PR.appendOrReplace(go, '<div class="pr-JSON-string" id="'+localID+'">'+jo+"</div>", replace);
                $("#"+localID).text(jo);
            } else 
            if(typeof jo === 'number' && isFinite(jo)) {
                PR.appendOrReplace(go, '<div class="pr-JSON-number">'+jo+"</div>", replace);
                if(keyID) {
                    $("#"+keyID).addClass("pr-JSON-sticky");
                }
            } else 
            if(jo && typeof jo === 'object' && jo.constructor === Array) {
                var localID = parentID+'-'+lc;
                PR.appendOrReplace(go, '<div class="pr-JSON-array" id="'+localID+'"></div>', replace);
                for(const jao of jo) {
                    lc = PR.renderJSON(lc, localID, jao, false, null);
                }
            } else 
            if(jo && typeof jo === 'object' && jo.constructor === Object) {
                var localID = parentID+'-'+lc;
                var localIDv = parentID+'-v'+lc;
                PR.appendOrReplace(go, '<div class="pr-JSON-object" id="'+localID+'"></div>', replace);
                go = $("#"+localID);
                for(const [key, val] of Object.entries(jo)) {
                    var localIDk = localID+'-k'+lc;
                    var localIDv = localID+'-v'+lc;
                    PR.appendOrReplace(go, '<div class="pr-JSON-key" id="'+localIDk+'"></div>' +
                                      '<div id="'+localIDv+'"></div>', replace);
                    $("#"+localIDk).text(key);
                    lc = PR.renderJSON(count+1, localIDv, val, true, localIDk);
                }
            } else {
                PR.appendOrReplace(go, '<div class="pr-JSON-null">null</div>', replace);
            }
            return lc;
        },
        connectButtons: function() {
            PR.ui_data.methods.map(function(m) {
                $("#"+m.name+"-submit").on("click", function(e) { 
                    $('html, body').animate({
                        scrollTop: $("#pr-view").offset().top
                    }, 2000);
                    var rqt = PR.form.getValue();
                    var rqtstr = JSON.stringify(rqt);
                    try { 
                        var xhr = $.ajax({
                            type: "POST",
                            url: m.url,
                            data: rqtstr,
                            cache: false,
							contentType: "application/json",
                            beforeSend: function(request) {
                                request.setRequestHeader("x-flow-time-calls", "1");
                                request.setRequestHeader("x-flow-asynchronous-calls", "1");
                                $("#pr-timing").html('');
                                $("#pr-response").html('');
                                $("#pr-message").html('<p class="pr-message-good">Sending request...</p>');
                            },
                            success: function(reply_obj, sts, jqxhr) {
                                /*
                                var reply_str = JSON.stringify(reply_obj, null, 4);
                                $("#pr-response").html('<pre style="color: green" id="pr-json-reply"></pre>');
                                $("#pr-json-reply").text(reply_str);
                                */
                                $("#pr-message").html('');
                                PR.renderJSON(0, "pr-response", reply_obj, false, null);
                                $('html, body').animate({
                                    scrollTop: $("#pr-view").offset().top
                                }, 2000);
                            },
							error: function(jqXHR, sts, exc) {
                                var emsg = (sts == null ? "error" : sts);
                                if(jqXHR.responseJSON != undefined) {
                                    emsg = jqXHR.responseJSON;
                                } else {
                                    emsg = "AJAX call " + emsg;
                                }
                                if(exc != null) emsg += "--"+exc;
                                PR.printError(emsg);
                            }
                        });
					} catch (ae) {
						PR.printError("system error");
					}
                    
                });
            });
        },
        printError: function(msg) {
            alert(msg);
            $("#pr-message").html('<p class="pr-message-error">'+msg+"</p>");
        },
    };
    PR.init(ui_data);
    PR.makeForm();
    PR.connectButtons();

    </script>
</body>
</html>
