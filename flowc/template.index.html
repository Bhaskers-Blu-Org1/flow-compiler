<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
        {{FLOWC_NAME}} v{{FLOWC_VERSION}} ({{FLOWC_BUILD}})
        Generated from {{INPUT_FILE}} ({{MAIN_FILE_TS}})
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>{{NAME_UPPER}} [REST Gateway]</title>

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <!-- CSS 
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.3.1/litera/bootstrap.css">
    <style>
        div[data-schemaid=root]>h3{ display: none; }
        div[data-schemaid=root]>p{ font-size: 125%; font-weight: bold; }
        div.pr-button { width: 220px; margin-left: 0px; margin-right: 20px; margin-top: 8px; display: inline-block; vertical-align: top; }
        p.form-text,  
        .pr-button-text {  font-style: italic; font-size: 75%;  white-space: normal; }
        label { font-weight: bold; }
        .pr-stick-on { position: relative; white-space: nowrap;  }
        .pr-stick-right { top: 0; right:0; position: absolute; }
        @media (max-width: 770px) {
            div.pr-button { display: block; }
        }
        p {  font-family: unset; }

        .pr-message-good { font-size: 90%; font-weight: bold; color: blue; }
        .pr-message-error { font-size: 90%; font-weight: bold; color: red; }
        #pr-message { margin-left: 24px; }
        #pr-message-details { margin-left: 24px; }

        #pr-response { font-size: 90%;  white-space: normal; }
        .pr-JSON-sticky, .pr-JSON-boolean, .pr-JSON-number, .pr-JSON-null { margin-right: 12px;  display: inline-block; }
        .pr-JSON-boolean { color: orange; }
        .pr-JSON-number { font-weight: bold; }
        .pr-JSON-null { color: red; }
        .pr-JSON-string { white-space: pre; }
        .pr-JSON-key { font-weight: bold; font-style: italic; }
        .pr-JSON-array {  }
        .pr-JSON-object { margin-left: 24px;  }
        .pr-JSON-tiptext, #pr-total-time, #pr-stage-time { font-weight: normal; font-size: 75% }
        #pr-total-time, #pr-stage-time { margin-left: 24px; margin-right: 24px; }
        .pr-stage-time { margin-left: 24px; }
        #pr-stage-time>.pr-stage-time-1 { margin-left: 0px; }
        .pr-stage-time-1 { background-color: #FFF0F0; }
        .pr-stage-time-2 { background-color: #F0FFF0; }
        .pr-stage-time-3 { background-color: #F0F0FF; }
        .pr-stage-time-4 { background-color: #FFFFF0; }
        .pr-stage-time-5 { background-color: #FFF0FF; }
        .pr-stage-time-0 { background-color: #F0FFFF; }
    </style>
</head>
<body>
    <!-- Navigation Bar
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-header-id" class="pr-header">
        <nav class="navbar navbar-expand-sm">
            <div class="navbar-nav mr-auto"><h3>{{NAME_UPPER}}{A:ACTIVE_NODE_UPPER{ - {{ACTIVE_NODE_UPPER}}}A}</h3></div>  
            <div class="navbar-expand ml-auto">
                <ul id="pr-nav-links" class="nav navbar-nav navbar-expand">
{A:ACTIVE_NODE_UPPER{{{HAVE_ACTIVE_NODE}}
                    <li class="nav-item" id="home-menu">
                        <a id="pr-home-link" class="nav-link" href="/-www/index.html">{{NAME}}</a>
                    </li>
}A}

{N:HAVE_CLI{{{HAVE_CLI}}
                    <li class="nav-item dropdown" id="nodes-dropdown">
                        <a id="pr-nodes-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Nodes<b class="caret"></b></a>
                        <div id="pr-nodes-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Internal Nodes</h5>
{C:CLI_NODE_NAME{
                            <a class="dropdown_item doc-selector" href="/-www/{{CLI_NODE_NAME}}-index.html">{{CLI_NODE_NAME}}</a>
                            <i>{{CLI_NODE_DESCRIPTION}}</i>
                            <br>
}C}
                        </div>
                    </li>
}N}
                    <li class="nav-item dropdown" id="graphs-dropdown">
                        <a id="pr-graphs-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Graphs<b class="caret"></b></a>
                        <div id="pr-graphs-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Node Connection Graphs</h5>
{I:ENTRY_NAME{
                            <a class="dropdown_item doc-selector" href="/-docs/{{ENTRY_NAME}}.svg">{{ENTRY_NAME}}</a>
                            <br>
}I}
                        </div>
                    </li>
                    <li class="nav-item dropdown" id="sources-dropdown">
                        <a id="pr-docs-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Sources<b class="caret"></b></a>
                        <div id="pr-docs-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Source Files</h5>
                            <a class="dropdown_item doc-selector" href="/-docs/{{MAIN_FILE}}">{{MAIN_FILE}}</a>
                            <i>{{NAME}} flow file</i>
                            <br>
{P:PROTO_FILE{
                            <a class="dropdown_item doc-selector" href="/-docs/{{PROTO_FILE}}">{{PROTO_FILE}}</a> 
                            <i>{{PROTO_FILE_DESCRIPTION}}</i>
                            <br>
}P}
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- Form Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="pr-panel">
        <div>
            <form method="post" action="#">
                <div id="pr-form-editor" class="m-4"></div>
            </form>
            <div id="pr-form-submit" class="m-4 pr-stick-on">
                <div class="form-group pr-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{MAIN_ENTRY_NAME}}" id="{{MAIN_ENTRY_NAME}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{MAIN_ENTRY_NAME}}</button>
                    <span class="pr-button-text">{{MAIN_ENTRY_DESCRIPTION_HTML}}</span>
                </div>
{I:ALT_ENTRY_NAME{              
                <div class="form-group pr-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{ALT_ENTRY_NAME}}" id="{{ALT_ENTRY_NAME}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{ALT_ENTRY_NAME}}</button>
                    <span class="pr-button-text">{{ALT_ENTRY_DESCRIPTION_HTML}}</span>
                </div>
}I}
                <div class="form-group pr-button pr-debug-button pr-stick-right">
                    <input type="checkbox" id="overlapped-calls" checked><span class="pr-button-text"> Overlapped gRPC Calls</span><br>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <!-- Messages Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-message-panel" class="pr-view-panel">
        <div class="m-4">
            <div class="row" id="pr-message"></div>
            <div class="row" id="pr-message-details"></div>
            <div class="row"><div id="pr-timing"></div>
                <button class="btn btn-outline-success btn-sm ml-auto mr-2 mb-2" id="download-request" style="display: none;" type=button>Download JSON Request</button>
                <button class="btn btn-outline-success btn-sm ml-auto mr-2 mb-2" id="download-response" style="display: none;" type=button>Download JSON Response</button>
            </div>
        </div>
    </div>
        <div id="pr-extra" class="pr-view-panel"></div>
    <hr>
    <!-- Results Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-view" class="pr-view-panel">
        <div id="pr-response"></div>
    </div>
    <!-- End Document
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jsonview/1.2.3/jquery.jsonview.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-json-editor/1.1.0/jquery-json-editor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@1.3.5/dist/jsoneditor.min.js"></script>
    <script>
        var ui_data = {
            "request-schema": {{MAIN_ENTRY_INPUT_SCHEMA_JSON}},
            "methods": [
                {
                    "name": "{{MAIN_ENTRY_NAME}}",
                    "url": "{{MAIN_ENTRY_URL}}",
                    "response-schema": {{MAIN_ENTRY_OUTPUT_SCHEMA_JSON}}
                }
{I:ALT_ENTRY_NAME{               ,{
                    "name": "{{ALT_ENTRY_NAME}}",
                    "url": "{{ALT_ENTRY_URL}}",
                    "response-schema": {{ALT_ENTRY_OUTPUT_SCHEMA_JSON}}
                }
}I}
            ]
        };
    window.PR = {
        ui_data: null,
        init: function(data) {
            PR.ui_data = data;
            JSONEditor.defaults.iconlibs.oi = JSONEditor.AbstractIconLib.extend({
                mapping: {
                    "delete": 'delete',
                    edit: 'pencil',
                    add: 'plus',
                    cancel: 'ban',
                    save: 'save',
                    moveup: 'arrow-thick-up',
                    movedown: 'arrow-thick-down',
                    clear: 'circle-x',
                    time: 'timer',
                    calendar: 'calendar',
                    upload: 'cloud-upload',
                },
                icon_class: 'oi',
                icon_prefix: 'oi oi-'
            });
        },
        prepareSchema: function(schema) {
            if('title' in schema && !('format' in schema) && schema['title'].match(/text$/i)) {
                schema['format'] = 'textarea';
            } 
            if('type' in schema && schema['type'] === 'object') {
                properties = schema['properties'];
                for([key, val] of Object.entries(properties)) 
                    PR.prepareSchema(val);
            }
        },
        makeForm: function() {
            var rqt_schema = PR.ui_data["request-schema"];
            rqt_schema["format"] = "grid";
            PR.prepareSchema(rqt_schema);
            PR.form = new JSONEditor($('#pr-form-editor')[0], {
                "schema" : rqt_schema,
                "theme" : "bootstrap4",
                "iconlib" : "oi",
                "template" : "handlebars",
                "disable_properties" : true,
                "disable_edit_json" : true
            });
        },
        appendOrReplace: function(obj, cont, repl) {
            if(repl) {
                obj.replaceWith(cont);
            } else {
                obj.html(obj.html()+cont);
            }
            return obj;
        },
        renderJSON: function(schema, container, objectID, jo, replace, keyO) {
            if(typeof value === 'boolean') {
                PR.appendOrReplace(container, '<div class="pr-JSON-boolean" id="'+objectID+'">'+jo+"</div>", replace);
                if(keyO) keyO.addClass("pr-JSON-sticky");
            } else 
            if(typeof jo === 'string' || jo instanceof String) {
                PR.appendOrReplace(container, '<div class="pr-JSON-string" id="'+objectID+'"></div>', replace);
                $("#"+objectID).text(jo);
                if(keyO && jo.length < 100 && jo.indexOf(' ') < 0) {
                    keyO.addClass("pr-JSON-sticky");
                    $("#"+objectID).addClass("pr-JSON-sticky");
                }
            } else 
            if(typeof jo === 'number' && isFinite(jo)) {
                PR.appendOrReplace(container, '<div class="pr-JSON-number" id="'+objectID+'">'+jo+"</div>", replace);
                if(keyO) keyO.addClass("pr-JSON-sticky");
            } else 
            if(jo && typeof jo === 'object' && jo.constructor === Array) {
                var lc = 0;
                PR.appendOrReplace(container, '<div class="pr-JSON-array" id="'+objectID+'"></div>', replace);
                container = $("#"+objectID);
                if(schema && 'type' in schema && schema['type'] === 'array' && 'items' in schema) 
                    schema = schema['items'];
                else 
                    schema = null;
                for(const jao of jo) {
                    lc = lc + 1;
                    var localID = objectID + "-" + lc;
                    PR.renderJSON(schema, container, localID, jao, false, null);
                }
            } else
            if(jo && typeof jo === 'object' && jo.constructor === Object) {
                var lc = 0;
                PR.appendOrReplace(container, '<div class="pr-JSON-object" id="'+objectID+'"></div>', replace);
                container = $("#"+objectID);
                var properties = null;
                if(schema && 'type' in schema && schema['type'] === 'object') 
                    properties = schema['properties'];

                for(const [key, val] of Object.entries(jo)) {
                    lc = lc + 1;
                    var localIDk = objectID+'-k'+lc;
                    var localIDv = objectID+'-v'+lc;
                    var localIDt = objectID+'-t'+lc;
                    PR.appendOrReplace(container, '<div class="pr-JSON-key" id="'+localIDk+'"></div><div id="'+localIDv+'"></div>', false);
                    var ko = $("#"+localIDk);
                    ko.text(key); 
                    if(properties && key in properties) 
                        schema = properties[key];
                    else
                        schema = null;
                    if(schema && 'description' in schema) {                                                                                     
                        ko.html(ko.html()+'<span class="pr-JSON-tiptext" id="'+localIDt+'"></span>');
                        $("#"+localIDt).text(schema['description']);
                    }
                    PR.renderJSON(schema, $("#"+localIDv), localIDv, val, true, ko);
                }
            } else {
                PR.appendOrReplace(container, '<div class="pr-JSON-null" id="'+objectID+'">null</div>', replace);
            }
        },
        connectButtons: function() {
            $('#download-response').on('click', function() {
                var a = document.createElement("a");
                var docstr = JSON.stringify(PR.response);
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(ocstr));
                a.setAttribute('download', "response.json");
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            $('#download-request').on('click', function() {
                var a = document.createElement("a");
                var docstr = JSON.stringify(PR.form.getValue());
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(docstr));
                a.setAttribute('download', "request.json");
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            $("#clear-button").on("click", function(e) { 
                PR.acedoc = {};
                $("#pr-message").html('');
                $("#pr-timing").html('');
                $("#acedoc-view").html('');
                $("#download-response").hide();
                $("#download-request").hide();
            });
            PR.ui_data.methods.map(function(m) {
                $("#"+m.name+"-submit").on("click", function(e) { 
                    $('html, body').animate({
                        scrollTop: $("#pr-view").offset().top
                    }, 2000);
                    var rqt = PR.form.getValue();
                    var rqtstr = JSON.stringify(rqt);
                    try { 
                        var xhr = $.ajax({
                            type: "POST",
                            url: m.url,
                            data: rqtstr,
                            cache: false,
							contentType: "application/json",
                            beforeSend: function(request) {
                                request.setRequestHeader("x-flow-time-call", "true");
                                if($('#overlapped-calls').is(":checked")) {
                                    request.setRequestHeader("x-flow-overlapped-calls", "1");
                                } else {
                                    request.setRequestHeader("x-flow-overlapped-calls", "0");
                                }
                                $("#pr-timing").html('');
                                $("#pr-response").html('');
                                $("#pr-message").html('<p class="pr-message-good">Sending request...</p>');
                                $("#download-response").hide();
                                $("#download-request").hide();
                            },
                            success: function(reply_obj, sts, jqxhr) {
                                $("#pr-message").html('');
                                PR.response = reply_obj;
                                PR.renderJSON(m["response-schema"], $("#pr-response"), "pr-response", reply_obj, true, null);
                                $('#download-request').show();
                                $('#download-response').show();
                                try {
                                    call_times = jqxhr.getResponseHeader('x-flow-call-times');
                                    call_times = JSON.parse(call_times);
                                    $("#pr-timing").html('<div><span id="pr-total-time"></span><span id="pr-stage-time"></span></div>');
                                    var total_log_time = 0;
                                    call_times.forEach(function(to) {
                                        if(to.stage == 0) {             
                                            total_time = to;
                                            $("#pr-total-time").html("Total time: <b>"+to['duration-u']+"</b>");
                                        } else {
                                            total_log_time = Math.log10(to.duration*1000) + total_log_time;
                                        }
                                    });
                                    if(call_times.length > 2) call_times.forEach(function(to) {
                                        if(to.stage != 0) {             
                                            var width_perc = Math.floor(Math.log10(to.duration*1000) * 100 / total_log_time);
                                            PR.appendOrReplace($("#pr-stage-time"), 
                                                "<span class='pr-stage-time'> "+to['stage-name']+": <b>"+to['duration-u']+"</b> </span>",
                                                false);
                                        }
                                    });
                                                          
                                } catch(ae) {
                                }
                                $('html, body').animate({
                                    scrollTop: $("#pr-view").offset().top
                                }, 2000);
                            },
							error: function(jqXHR, sts, exc) {
                                var emsg = (sts == null ? "error" : sts);
                                if(jqXHR.responseJSON != undefined) {
                                    emsg = jqXHR.responseJSON;
                                }
                                var details = '';
                                if(emsg && typeof emsg === 'object' && emsg.constructor === Object) {
                                    if('code' in emsg && emsg['code'] == 500) {
                                        details = emsg["details"]; 
                                        emsg = '[' + emsg["from"] + '] gRPC Error ' + emsg["grpc-code"] + ': ' + emsg['message'];
                                    } else {
                                        emsg = JSON.stringify(emsg);
                                    }
                                }
                                PR.printError(emsg, details);
                            }
                        });
					} catch (ae) {
						PR.printError("system error");
					}
                    
                });
            });
        },
        printError: function(msg, description) {
            alert(msg+'\n'+description);
            $("#pr-message").html('<p class="pr-message-error">'+msg+"</p>");
            $("#pr-message-details").text(description);
        },
    };
    PR.init(ui_data);
    PR.makeForm();
    PR.connectButtons();

    </script>
</body>
</html>
